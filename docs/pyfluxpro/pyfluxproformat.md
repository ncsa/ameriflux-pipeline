# Documentation on pyfluxproformat module
This document is a code walk-through on pyfluxpro/pyfluxproformat.py module

## Overview
- The [pyfluxproformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pyfluxpro/pyfluxproformat.py) process creates the pyfluxpro input excel sheet for the mainstem processing.
- The module creates pyfluxpro input excel sheet with the output from [mastermetprocessor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/master_met/mastermetprocessor.md) and the full_output sheet from [eddypro run](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md).
- This excel sheet is used as input for the PyFluxPro software
- The pipeline calls this process in [step#11](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md#11) of pre-pyfluxpro module, after the [runeddypro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md) process.

## Instructions to run

### Using the GUI
- There is an option to run this module independently. 
- This can be achieved using the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) GUI and clicking the "Run" button in the "Run PyFluxPro data preparation" section.

### Using the command line
- Running ```python pre_pyfluxpro.py``` will execute this process along with other modules within [pre_pyfluxpro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md) module.

## Process

### 1
- This process takes eddypro full output sheet and the master meterological data file as inputs.
- The eddypro full output sheet is generated by the [runeddypro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md) module.
- The master meterological data is generated by the [mastermetprocessor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/master_met/mastermetprocessor.md) module.
- The user gets to assign the sheet name for eddypro full output in the configuration FULL_OUTPUT_PYFLUXPRO and meteorological data sheet name in the configuration MET_DATA_30_PYFLUXPRO.

### 2
- The eddypro full output sheet is read and validated for expected format.
- Validations include checking for 'time' and 'date' column and for 'sonic temperature' and 'air pressure'
- If any of these columns are not present the validation has failed and the process is aborted.

### 3
- A 'TIMESTAMP' column is added to the full_output sheet by concatenating the 'date' and 'time' column.
- The timestamp is shifted 30min behind as explained in [NOTES#22](https://github.com/ncsa/ameriflux-pipeline/blob/develop/NOTES.md#22).

### 4
- The sonic_temperature measurement unit is changed from Kelvin to Celsius.
- The air_pressure measurement unit is changed from Pa to kPa.

### 5
- The formatted full_output sheet is written to configuration file mentioned in FULL_OUTPUT_PYFLUXPRO.
- The master meterological data file is written to configuration file mentioned in MET_DATA_30_PYFLUXPRO.

### 6
- If the user sets pyfluxpro_overlap_timestamp_check to True, the code checks if fulloutput and meteorological data sheet has overlapping timestamps.
- If set to True, and if no overlapping timestamps are found, an error is logged and process is aborted.
- If set to False, the chek for overlapping timestamp is not performed.

### 7
- Both fulloutput and meteorological data sheet is written to an excel sheet specified by the user in PYFLUXPRO_INPUT_SHEET.
