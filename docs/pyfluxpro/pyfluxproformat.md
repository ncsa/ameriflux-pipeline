# Documentation on pyfluxproformat module
This document is a code walk-through on pyfluxpro/pyfluxproformat.py module

## Overview
- The [pyfluxproformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pyfluxpro/pyfluxproformat.py) process creates the pyfluxpro input excel sheet for the mainstem processing.
- The module creates pyfluxpro input excel sheet with the output from [mastermetprocessor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/master_met/mastermetprocessor.md) and the full_output sheet from [eddypro run](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md).
- This excel sheet is used as input for the PyFluxPro software
- The pipeline calls this process in [step#11](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md#11) of pre-pyfluxpro module, after the [runeddypro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md) process.

## Instructions to run

### Using the GUI
- There is an option to run this module independently. 
- This can be achieved using the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) GUI and clicking the "Run" button in the "Run PyFluxPro data preparation" section.

### Using the command line
- Running ```python pre_pyfluxpro.py``` will execute this process along with other modules within [pre_pyfluxpro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md) module.

## Process

### 1
- This process takes eddypro full output sheet and the master meterological data file as inputs.
- The eddypro full output sheet is generated by the [runeddypro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md) module.
- The master meteorological data is generated by the [mastermetprocessor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/master_met/mastermetprocessor.md) module.
- The user may assign the sheet name for eddypro full output in the .env setting FULL_OUTPUT_PYFLUXPRO and meteorological data sheet name in the .env setting MET_DATA_30_PYFLUXPRO.
### 2
- The eddypro full output sheet is read and validated for expected format.
- Validations include checking for 'time' and 'date' column and for 'sonic temperature' and 'air pressure'
- If any of these columns are not present the validation has failed and the process is aborted.

### 3
- A 'TIMESTAMP' column is added to the full_output sheet by concatenating the 'date' and 'time' column.
- The eddypro timestamp is shifted 30min backward to match the meteorological data timestamp as explained in [NOTES#22](https://github.com/ncsa/ameriflux-pipeline/blob/develop/NOTES.md#22).

### 4
- The sonic_temperature measurement unit is changed from Kelvin to Celsius.
- The air_pressure measurement unit is changed from Pa to kPa.

### 5
- The formatted full_output sheet is written to the filename specified in the  .env setting FULL_OUTPUT_PYFLUXPRO.
- The master meteorological data file is written to the filename specified in the .env setting MET_DATA_30_PYFLUXPRO.

### 6
- The PyFluxPro software will throw an error if the met data sheet and the full output sheet do not have an overlapping timestamps.
- This is checked by setting the [pyfluxpro_overlap_timestamp_check](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L49) to True.
- If this is set to True, the pyfluxpro_input excel sheet is created only if the met data sheet and eddypro full output sheet has at least 1 common timestamp.
- If this condition is to be ignored, set the pyfluxpro_overlap_timestamp_check to False.

### 7
- Both fulloutput and meteorological data sheet is written to an excel sheet specified by the user in PYFLUXPRO_INPUT_SHEET.
