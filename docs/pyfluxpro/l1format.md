# Documentation on l1format module
This document is a code walk-through on l1format.py module

## Overview
- The [l1format](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pyfluxpro/l1format.py) process creates the L1 control file for EPL-type processing.
- The module creates L1 text file based on the input L1 template file and the pyfluxpro input excel sheet produced by [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) process.
- This L1 control file is used to run L1 processing in the PyFluxPro software. 
- The pipeline calls this process in [step#14](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md#14) of pre-pyfluxpro module, after the [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) process.

## Instructions to run

### Using the GUI
- There is an option to run this module from the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) GUI.
- Launch the GUI by executing ```python pipeline.py``` command.
- Click the "Run" button in the "Run PyFluxPro data preparation" section.

### Using the command line
- Running ```python pre_pyfluxpro.py``` will execute this process along with other modules within [pre_pyfluxpro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md) module.

## Process

### 1
- Inputs required by this module are described in [step#14](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md#14) of pre-pyfluxpro module
- These inputs can be set from the [enveditor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/enveditor.md).

### 2
- Validations are done for all inputs
- The L1 template file is checked to see if the "[Files]", "[Global]" and "[Variables]" section exists and if the "level" is "L1".
- The Ameriflux-Mainstem-Key file is validated for the required column names. The typical column names expected are : 'Original variable name', 'Ameriflux variable name', 'Input sheet variable name', 'Units after formatting'.
- Erroring variable key file is checked if columns "Ameriflux variable name" and "Pyfluxpro variable name" exists.

### 3
- The file path of the  pyfluxpro input excel sheet (generated by the [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) process) which will be used for the "file_path" and "in_filename" values.
- In the output L1 file, the "in_headerrow" is set as 1 and "in_firstdatarow" will be set as 3 to match the format of the input PyFluxPro excel sheet. 
- The correct site name is filled in the "site_name" line in "Global" section.

###
- Each variable in the L1 template file contains an attribute (subsection) titled “xl”. This attribute specifies which column name in the input file should be matched to and read in for that variable.
- Some variables must have their “xl” (for input column names) or “units” attribute changed to alterations made earlier in the pipeline. The correct matching for these changes is specified in the Ameriflux-Mainstem Key, Soils key, or Erroring variables key.

### 4
- For the "[Variables]" section, each variable will be written to output L1 only if it is present in the Ameriflux-Mainstem Key or in the Soils key.
- The "xl" and "units" attributes are updated as necessary using the Ameriflux-Mainstem Key, Soils key, and Erroring variables key.
- The column name specified in each variable’s "xl" attribute is checked to see whether it is present in the PyFluxPro input excel sheet. If a variable is not present in the sheet, a warning message is logged.
- The Soils key specifies instrument depths in centimeters. The “height” attribute in the output L1 should instead be given as height in meters. To convert from centimeters depth to meters height, divide by 100 and reverse the sign. Write the corrected value to the “height: attribute for each soil variable.
- Get the instrument listed in the Soils key and write it to the "instrument" attribute of each soil variable.
- When writing to L1, validation is done to check if there are duplicate variables.

### 5
- On successful completion, a message will be logged and output L1 file will be written to the location specified by .env L1_AMERIFLUX.



