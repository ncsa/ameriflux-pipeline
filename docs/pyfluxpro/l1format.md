# Documentation on l1format module
This document is a code walk-through on l1format.py module

## Overview
- The [l1format](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pyfluxpro/l1format.py) process creates the L1 control file for EPL-type processing.
- The module creates L1 text file based on the input L1 template file and the pyfluxpro input excel sheet produced by [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) process.
- This L1 control file is used as input for the PyFluxPro software. 
- The pipeline calls this process in [step#14](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md#14) of pre-pyfluxpro module, after the [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) process.

## Instructions to run

### Using the GUI
- There is an option to run this module from the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) GUI.
- Launch the GUI by executing ```python pipeline.py``` command.
- Click the "Run" button in the "Run PyFluxPro data preparation" section.

### Using the command line
- Running ```python pre_pyfluxpro.py``` will execute this process along with other modules within [pre_pyfluxpro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md) module.

## Process

### 1
- Inputs required by this module are described in [step#14](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/prepyfluxpro.md#14) of pre-pyfluxpro module
- These inputs can be set from the [enveditor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/enveditor.md).

### 2
- Validations are done for all inputs
- The L1 files are checked if the "[Files]", "[Global]" and "[Variables]" section exists and if the "level" is "L1".
- The Ameriflux-Mainstem-Key file is validated for the required column names
- Erroring variable key file is checked if columns "Ameriflux variable name" and "Pyfluxpro variable name" exists.

### 3
- The pyfluxpro input excel sheet generated by the [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) process, which will be used for the "file_path" and "in_filename" values.
- In the output L1 file, the "in_headerrow" is set as 1 and "in_firstdatarow" is set as 3. 
- The correct site name is filled in the "site_name" line in "Global" section.

### 4
- For the "[Variables]" section, each variable will be written to output L1 only if it is present in the Ameriflux-Mainstem Key or in the Soils key.
- Each variable is checked to see if it is present in the input sheet mentioned in the "xl" attribute. If a variable is not present in the sheet, a warning message is logged.
- The meteorological variable names (from the xl attribute) will be renamed and units changed if necessary, as per the key files (Ameriflux-Mainstem Key, Soils key, Erroring variables key).
- For soil variables, the height is given in centimeter in Soils key. Convert cm to m, reverse the sign and write the corrected height (a negative value) in the height attribute in L1.
- For soil variables, get the instrument from Soils key and write in "instrument" attribute.
- When writing to L1, validation is done to check if there are duplicate variables.

### 5
- On successful completion, a message will be logged and output L1 file will be written to the user specified location.



