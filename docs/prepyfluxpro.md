# Documentation on pre-pyfluxpro module
This document will describe the pre_pyfluxpro.py module

## Overview
- This module does all the processing till the generation on PyFluxPro L1 and L2 control files.
- This is typically the second step in the pipeline, run after the metprocessor module.
- The module uses the settings from .env file generated by [enveditor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/enveditor.md) module.
- All logs are recorded in the log file named pre_pyfluxpro.log
- This module creates :
  - master met data, 
  - master met data formatted for eddypro, 
  - eddypro full output, 
  - pyfluxpro input excel sheet, 
  - pyfluxpro input excel sheet formatted for Ameriflux, 
  - L1 and L2 control files formatted for Ameriflux,
  - log file pre_pyfluxpro.log, and log file for each eddypro run in eddypro output folder.
- There is also an option to run each process separately. This can be achieved using the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) GUI.

## Instructions to run

## Using GUI
- Please run command ```python pipeline.py```.
- On launch of GUI, click "Run" button under the "Pre-Pyfluxpro Process".
- The required settings are read from .env file.

### Using command line
- Please run using command ```python pre_pyfluxpro.py```.
- The settings are read from .env file

## Process
- pre_pyfluxpro module is typically the second step in the pipeline, run after the metprocessor module.

### 1
- The ```run()``` method is called first which starts the pre_pyfluxpro module.
- The ```run()``` method takes in an argument, which by default is 1.
- The default value of 1 signifies that all modules within the pre_pyfluxpro module is to be executed.
- The value of the argument can be changed by the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) module, which enable separate execution on modules.
- This document will describe the actions taken when the argument value is 1.

### 2
- All settings from the .env file is validated.
- Validations are performed by methods in [utils.input_validation](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/utils/input_validation.py) module.
- If validations return false, an error is logged and process aborted.

### 3
- Some Pyfluxpro labels when renamed to ameriflux friendly labels, throw an error in PyFluxPro V3.3.2.
- These variables are called 'Erroring variables' and PyFluxPro software throws an error when these variables are converted to ameriflux standard names.
- These erroring variables are mentioned in a separate excel input file given in env variable L1_AMERIFLUX_ERRORING_VARIABLES_KEY.
- A confirmation on whether this step is required or not is checked.
- If the env variable AMERIFLUX_VARIABLE_USER_CONFIRMATION is "N", it signifies that some pyfluxpro variable names are not to be renamed.
- If the AMERIFLUX_VARIABLE_USER_CONFIRMATION is "N", an erroring variable key is need to check which all variables are not be renamed.
- Variables are renamed to ameriflux standards in [post_pyfluxpro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/post_pyfluxpro.py) module.

### 4
- If env variable SFTP_CONFIRMATION is "Y", user has requested to sync the local machine with a remote desktop location.
- As per user request, the [Sync module](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/utils/syncdata.md) is executed.
- Sync module is skipped by default.
- If the Sync module needs to be run, the user inputs can be configured by setting SHOW_DATA_SYNC to be True in [enveditor.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/enveditor.py#L29)

### 5
- The env variable INPUT_MET is read as the input meteorological file that is to be processed to create a master meteorological data.

### 6
- A file meta data (csv file) is created in the same path as the INPUT_MET.
- This file stores the file meta data information (first row of INPUT_MET).
- The file would contain the site name, which is used for further processing.

### 7
- In the pre_pyfluxpro module, the [pre_processing()](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L322) method is the main method that calls other functions.
- This method is responsible for the creation of mastermet data and eddypro and pyfluxpro input files.
- Each of these steps are validated for successful execution. If any of the steps fail, an error message is logged and the process aborted.

### 8
- pre_processing() method first calls the [eddypro_preprocessing()](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L78) method to create the mastermet data and format it for eddypro input.
- eddypro_preprocessing() method calls [mastermetprocessor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/master_met/mastermetprocessor.md) module to create the mastermet data 
- The master met data is written to the filepath mentioned in env variable MASTER_MET and the file meta data is written to file created in step #6.
- Secondly, the eddypro_processing() method calls [eddyproformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/eddyproformat.md) module to format the mastermet for eddypro input and stores the site soil moisture and temperature variables.

### 9
- Next step is to run eddypro software in a headless manner.
- The eddypro output path that is chosen by the user in the env variable EDDYPRO_OUTPUT_PATH is checked for empty directory.
- If the directory is not empty, all contents are moved to another directory named "_run_result_<timestamp>".
- This is done as the headless run would overwrite the eddypro output directory.
- The pre_processing() method now calls the [runeddypro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/runeddypro.md) module, which runs the EddyPro software in a headless manner.
- Please check the README [requirements](https://github.com/ncsa/ameriflux-pipeline#requirements) section for suitable EddyPro software version.

### 10
- On successful run of the runeddypro module, the eddypro 'full_output' file is checked in the EDDYPRO_OUTPUT_PATH variable.
- If the 'full_output' file does not exists, the process is aborted.

### 11
- On successful completion of the eddypro run, pyfluxpro processing is started.
- The [pyfluxpro_processing()](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L138) method is responsible for creating the pyfluxpro input sheet for mainstem processing.
- This method calls the [pyfluxproformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/pyfluxproformat.md) module to format the eddypro fulloutput to pyfluxpro standards.
- If formatting of the full_output sheet is not successful, an error message is logged and process aborted.
- PyFluxPro software throws an error if the met data sheet and the full output sheet does not have an overlapping timeperiod.
- This is checked by setting the [pyfluxpro_overlap_timestamp_check](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L49) to True.
- If this is set to True, the pyfluxpro_input excel sheet is created only if the met data sheet and eddypro full output sheet has at least 1 common timestamp.
- If this condition is to be ignored, set the pyfluxpro_overlap_timestamp_check to False.

### 12
- The pyfluxpro_processing() method takes the full_output and writes to env variable FULL_OUTPUT_PYFLUXPRO and meteorological data to MET_DATA_30_PYFLUXPRO.
- The method also writes the two sheets to an excel file given in env variable PYFLUXPRO_INPUT_SHEET.
- The full_output sheet will be named the filename given in FULL_OUTPUT_PYFLUXPRO and meteorological data sheet will be named the filename given in MET_DATA_30_PYFLUXPRO.

### 13
- On successful creation of pyfluxpro input sheet, the pre_pyfluxpro module calls [pyfluxpro_ameriflux_processing()](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L216) method to create pyfluxpro input sheet for ameriflux processing.
- This method calls the [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) module to format pyfluxpro input sheet (given in env variable PYFLUXPRO_INPUT_SHEET) to ameriflux standards.
- The method writes the formatted pyfluxpro input file to env variable PYFLUXPRO_INPUT_AMERIFLUX.
- This method also saves the full_output variable names and meteorological data variable names for further processing.

### 14
- On successful creation of the PYFLUXPRO_INPUT_AMERIFLUX, process is started to create L1 Control file to be used for ameriflux processing.
- pre_pyfluxpro module calls [pyfluxpro_l1_ameriflux_processing()](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L260) method for this.
- This method takes in inputs : 
  - PYFLUXPRO_INPUT_AMERIFLUX 
    - pyfluxpro input sheet formatted for ameriflux
  - L1_MAINSTEM_INPUT 
    - Pyfluxpro L1 control file used for mainstem processing. 
    - Variables present in this file is written to output L1 after validation checks. 
    - This file also gives Attribute information on variables and the details in the Global section.
  - L1_AMERIFLUX_ONLY_INPUT 
    - Pyfluxpro L1 control file containing ameriflux-only variables (variables not present in the mainstem processing).
  - L1_AMERIFLUX_MAINSTEM_KEY 
    - an excel file that the user can use to select which all variables to write in the output L1 file. 
    - Only those variables present in this file will be written to output L1.
    - The content description of this file can be found in config.md.
  - file_meta_data_file
    - The file containing the file-level meta data of meteorological data. 
    - This file is created in step #6.
  - L1_AMERIFLUX_RUN_OUTPUT
    - User input filepath (.nc) where the pyfluxpro L1 run output should be written.
  - L1_AMERIFLUX
    - User input filepath where the output L1 should be written
  - AMERIFLUX_VARIABLE_USER_CONFIRMATION
    - Described in step#3.
  - L1_AMERIFLUX_ERRORING_VARIABLES_KEY
    - Described in step#3.
  - site_soil_moisture_variables
    - site soil moisture variable names stored by the [eddyproformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/eddyproformat.md) mentioned in step#8.
  - site_soil_temp_variables
    - site soil temperature variable names stored by the [eddyproformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/eddypro/eddyproformat.md) mentioned in step#8.
  - full_output_variables
    - full output variable names stored by [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) module mentioned in step#13.
  - met_data_variables
    - meteorological data variable names stored by [amerifluxformat](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/amerifluxformat.md) module mentioned in step#13.
  - met_data_sheet_name
    - filename given in MET_DATA_30_PYFLUXPRO explained in step#12.
  - full_output_sheet_name
    - filename given in FULL_OUTPUT_PYFLUXPRO explained in step#12.
- pyfluxpro_l1_ameriflux_processing() method calls the [l1format](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/l1format.md) module with these inputs.
- l1format module creates L1 Control file for ameriflux processing and stores variable names mapping from pyfluxpro and meteorological labels to ameriflux labels.
- If creation of L1 file is unsuccessful, an error message is logged and process aborted.

### 15
- Once L1 control file is created, pre_pyfluxpro module calls [pyfluxpro_l2_ameriflux_processing()](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pre_pyfluxpro.py#L302) method to create L2 control file.
- This method takes in input :
  - ameriflux_mapping
    - variable mapping from pyfluxpro labels and meteorological labels to ameriflux standard labels. 
    - This is created in l1format module described in step#14.
  - L2_MAINSTEM_INPUT
    - Pyfluxpro L2 control file used for mainstem processing. 
    - Variables present in this file is written to output L2 after validation checks. 
    - This file also gives additional checks on variables like RangeCheck and ExcludeDates.
  - L2_AMERIFLUX_ONLY_INPUT
    - Pyfluxpro L2 control file containing ameriflux-only variables (variables not present in the mainstem processing).
  - L1_AMERIFLUX_RUN_OUTPUT
    - User input filepath (.nc) where the pyfluxpro L1 run output should be written.
  - L2_AMERIFLUX_RUN_OUTPUT
    - User input filepath (.nc) where the pyfluxpro L2 run output should be written.
  - L2_AMERIFLUX
    - User input filepath where the output L2 should be written.
- pyfluxpro_l2_ameriflux_processing() method calls the [l2format](https://github.com/ncsa/ameriflux-pipeline/blob/develop/docs/pyfluxpro/l2format.md) module with these inputs.
- l2format module creates L2 Control file for ameriflux processing.
- If creation of L2 file is unsuccessful, an error message is logged and process aborted.

### 16
- If creation of L1 and L2 control files are successfull, pre_pyfluxpro module is completed and processes is ended.
- Logs can be found in file pre_pyfluxpro.log.

### 17
- With the generated L1 and L2 control files for ameriflux processing, users can run PyFluxPro V3.3.2 software and generate plots.
- Technicians can make neccessary adjustments to the L1 and L2 control files and re-run the PyFluxPro software if neccessary.
- Launching and running PyFluxPro software is a manual process.
- Logs can be found in file pre_pyfluxpro.log.
