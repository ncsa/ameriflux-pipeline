# Documentation on pre-pyfluxpro module
This document will describe the pre_pyfluxpro.py module

## Overview
- This module does all the processing till the generation on PyFluxPro L1 and L2 control files.
- The module uses the settings from .env file generated by [enveditor](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/enveditor.py) module.
- This is typically the second step in the pipeline, run after the metprocessor module.
- All logs are recorded in the log file named pre_pyfluxpro.log
- This module creates :
  - master met data, 
  - master met data formatted for eddypro, 
  - eddypro full output, 
  - pyfluxpro input excel sheet, 
  - pyfluxpro input excel sheet formatted for Ameriflux, 
  - L1 and L2 control files formatted for Ameriflux,
  - log file pre_pyfluxpro.log, and log file for each eddypro run in eddypro output folder.
- There is also an option to run each process separately. This can be achieved using the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) GUI.

## Instructions to run

### Using command line
- Please run using command ```python pre_pyfluxpro.py```.
- The settings are read from .env file

## Process
- pre_pyfluxpro module is typically the second step in the pipeline, run after the metprocessor module.

### 1
- The ```run()``` method is called first and it starts the pre_pyfluxpro module.
- The ```run()``` method takes in an argument, which by default is 1.
- The default value of 1 signifies that all modules within the pre_pyfluxpro module is to be executed.
- The value of the argument can be changed by the [pipeline.py](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/pipeline.py) module, which enable separate execution on modules.
- This document will describe the actions taken when the argument value is 1.

### 2
- All settings from the .env file is validated.
- Validations are performed by methods in [utils.input_validation](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/utils/input_validation.py) module.
- If validations return false, an error is logged and process aborted.

### 3
- A confirmation on whether the some ameriflux variable names are to be renamed in Pyfluxpro L1 control file is checked.
- If the env variable AMERIFLUX_VARIABLE_USER_CONFIRMATION is "N", it signifies that some ameriflux variable names are not to be renamed.
- If the AMERIFLUX_VARIABLE_USER_CONFIRMATION is "N", an erroring variable key is need to check which all varaibles are not be renamed.
- These variables are called 'Erroring variables' and PyFluxPro software throws an error when these variables are converted to ameriflux standard names.
- Variables are renamed to ameriflux standards in [post_pyfluxpro](https://github.com/ncsa/ameriflux-pipeline/blob/develop/ameriflux_pipeline/post_pyfluxpro.py) module.

### 4
- The env variable INPUT_MET is read as the input meteorological file that is to be processed to create a master meteorological data.

### 5
- A file meta data (csv file) is created in the same path as the INPUT_MET.
- This file stores the file meta data information.

